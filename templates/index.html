<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠n di·ªán c√¥n tr√πng tr√™n c√¢y</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: #f6fef7;
        }
        .header {
            background: linear-gradient(90deg, #43a0c4 0%, #88dee3 100%);
            color: #fff;
            padding: 32px 0 24px 0;
            text-align: center;
            border-radius: 0 0 32px 32px;
            box-shadow: 0 4px 16px rgba(67,196,101,0.08);
            margin-bottom: 32px;
        }
        .header h1 {
            font-family: 'Quicksand', Arial, sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            border-radius: 24px;
            box-shadow: 0 2px 16px rgba(67,196,101,0.07);
            padding: 32px 24px;
        }
        .section-title {
            color: #43c465;
            font-family: 'Quicksand', Arial, sans-serif;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 18px;
        }
        .img-preview, .img-result {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(67,196,101,0.10);
            border: 2px solid #e0f2e9;
            margin-bottom: 12px;
            max-width: 100%;
        }
        .table-result th {
            background: #43c465;
            color: #fff;
            font-weight: 600;
        }
        .table-result td {
            background: #f6fef7;
        }
        .btn-main {
            background: linear-gradient(90deg, #ffb347 0%, #ffcc80 100%);
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            padding: 10px 28px;
            margin-top: 8px;
            margin-bottom: 12px;
            transition: background 0.2s;
        }
        .btn-main:hover {
            background: linear-gradient(90deg, #ff9800 0%, #ffd699 100%);
            color: #fff;
        }
        .status-box {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .status-ok {
            background: #e0f2e9;
            color: #43c465;
        }
        .status-err {
            background: #ffe0e0;
            color: #d32f2f;
        }
        @media (max-width: 900px) {
            .main-container { padding: 18px 4px; }
        }
        @media (max-width: 768px) {
            .main-container { padding: 8px 2px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå± Nh·∫≠n di·ªán c√¥n tr√πng tr√™n c√¢y</h1>
        <div style="font-size:1.1rem; font-weight:400; margin-top:8px;">·ª®ng d·ª•ng AI h·ªó tr·ª£ nh√† n√¥ng ph√°t hi·ªán s√¢u b·ªánh nhanh ch√≥ng</div>
    </div>
    <div class="main-container">
        <div class="row g-4">
            <!-- C·ªôt tr√°i: Upload v√† k·∫øt qu·∫£ -->
            <div class="col-lg-6 col-md-12">
                <div class="mb-4">
                    <div class="section-title">1. T·∫£i ·∫£nh c√¥n tr√πng ho·∫∑c l√° c√¢y b·ªã b·ªánh</div>
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        <input type="file" name="file" accept="image/*" required onchange="previewImage(event)" class="form-control mb-2">
                        <button type="submit" class="btn btn-main w-100">D·ª± ƒëo√°n t·ª´ ·∫£nh t·∫£i l√™n</button>
                    </form>
                    <img id="preview" src="#" alt="·∫¢nh xem tr∆∞·ªõc" class="img-preview" style="display:none;">
                </div>
                {% if result_img %}
                <div class="mb-3">
                    <div class="section-title">2. ·∫¢nh g·ªëc</div>
                    {% if original_img %}
                        <img src="{{ original_img }}" alt="·∫¢nh g·ªëc" class="img-preview">
                    {% endif %}
                </div>
                <div class="mb-3">
                    <div class="section-title">3. K·∫øt qu·∫£ nh·∫≠n di·ªán</div>
                    <img src="{{ result_img }}" alt="K·∫øt qu·∫£" class="img-result mb-2">
                    {% if details %}
                        <table class="table table-result table-bordered">
                            <tr>
                                <th>STT</th>
                                <th>T√™n lo√†i</th>
                                <th>Confidence</th>
                                <th>Bounding Box</th>
                            </tr>
                            {% for d in details %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ d.name }}</td>
                                <td>{{ d.confidence }}</td>
                                <td>{{ d.bbox }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    {% else %}
                        <div class="status-box status-err">Kh√¥ng ph√°t hi·ªán c√¥n tr√πng n√†o!</div>
                    {% endif %}
                </div>
                <div class="mb-3">
                    <div class="section-title">4. ƒê·ªëi chi·∫øu v·ªõi nh√£n th·∫≠t (ground truth)</div>
                    {% if ground_truth %}
                        <table class="table table-result table-bordered">
                            <tr>
                                <th>STT</th>
                                <th>T√™n lo√†i</th>
                                <th>Bounding Box</th>
                            </tr>
                            {% for g in ground_truth %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ g.name }}</td>
                                <td>{{ g.bbox }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    {% else %}
                        <div class="status-box status-err">Kh√¥ng t√¨m th·∫•y nh√£n th·∫≠t cho ·∫£nh n√†y.</div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <!-- C·ªôt ph·∫£i: Camera ESP32 -->
            <div class="col-lg-6 col-md-12">
                <div class="mb-4">
                    <div class="section-title">Ho·∫∑c s·ª≠ d·ª•ng Camera ESP32</div>
                    <div class="camera-container mb-2 text-center">
                        <img id="esp32LiveView" src="http://{{ esp32_ip }}/stream" alt="ESP32-CAM Live" class="img-preview" onerror="handleStreamError()" />
                        <div class="status-box status-ok" id="cameraStatus">ƒêang k·∫øt n·ªëi...</div>
                    </div>
                    <button onclick="predictEsp32()" class="btn btn-main w-100">Ch·ª•p v√† d·ª± ƒëo√°n t·ª´ camera</button>
                    <div id="esp32_result_container" style="display:none; margin-top: 20px;">
                        <div class="section-title">K·∫øt qu·∫£ nh·∫≠n di·ªán t·ª´ camera</div>
                        <img id="esp32_result_img" class="img-result mb-2">
                        <div id="esp32_result_table"></div>
                        <div id="esp32_gt_table"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- B·∫£ng l·ªãch s·ª≠ d·ª± ƒëo√°n -->
    <div class="main-container mt-4">
        <h2 class="mb-4" style="color:#43c465; font-weight:700;">L·ªãch s·ª≠ d·ª± ƒëo√°n</h2>
        {% if history and history|length > 0 %}
        <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Th·ªùi gian</th>
                    <th>Lo·∫°i</th>
                    <th>T√™n ·∫£nh</th>
                    <th>K·∫øt qu·∫£</th>
                    <th>·∫¢nh k·∫øt qu·∫£</th>
                </tr>
            </thead>
            <tbody>
                {% for h in history|reverse %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ h.time }}</td>
                    <td>{{ 'ESP32-CAM' if h.type=='esp32' else 'Upload' }}</td>
                    <td>{{ h.image }}</td>
                    <td>
                        {% if h.details and h.details|length > 0 %}
                            <ul style="padding-left:18px;">
                            {% for d in h.details %}
                                <li><b>{{ d.name }}</b> ({{ d.confidence if d.confidence else '' }})<br>BBox: {{ d.bbox }}</li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <span style="color:#d32f2f;">Kh√¥ng ph√°t hi·ªán c√¥n tr√πng</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if h.result_img %}
                            <img src="{{ h.result_img }}" class="img-result" alt="K·∫øt qu·∫£" style="max-width:120px; border-radius:8px; border:2px solid #e0f2e9;">
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
            <div class="alert alert-warning">Ch∆∞a c√≥ l·ªãch s·ª≠ d·ª± ƒëo√°n n√†o.</div>
        {% endif %}
    </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function previewImage(event) {
        var input = event.target;
        var reader = new FileReader();
        reader.onload = function(){
            var img = document.getElementById('preview');
            img.src = reader.result;
            img.style.display = 'block';
        };
        if(input.files && input.files[0]){
            reader.readAsDataURL(input.files[0]);
        }
    }
    const esp32_ip = "{{ esp32_ip }}";
    function handleStreamError() {
        document.getElementById('cameraStatus').textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn ESP32-CAM';
        document.getElementById('cameraStatus').className = 'status-box status-err';
    }
    async function predictEsp32() {
        const liveView = document.getElementById('esp32LiveView');
        liveView.style.display = 'none';
        liveView.src = '';
        document.getElementById('cameraStatus').textContent = 'ƒêang x·ª≠ l√Ω...';
        document.getElementById('cameraStatus').className = 'status-box status-ok';
        try {
            const response = await fetch('/predict_esp32', { method: 'POST' });
            const result = await response.json();
            if (!result.success) {
                document.getElementById('cameraStatus').textContent = 'L·ªói: ' + result.error;
                document.getElementById('cameraStatus').className = 'status-box status-err';
                return;
            }
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const resultContainer = document.getElementById('esp32_result_container');
            const resultImg = document.getElementById('esp32_result_img');
            const resultTable = document.getElementById('esp32_result_table');
            const gtTable = document.getElementById('esp32_gt_table');
            resultImg.src = result.result_img + '?t=' + new Date().getTime();
            resultContainer.style.display = 'block';
            // B·∫£ng k·∫øt qu·∫£
            let html = '<table class="table table-result table-bordered"><tr><th>STT</th><th>T√™n lo√†i</th><th>Confidence</th><th>Bounding Box</th></tr>';
            result.details.forEach((d, i) => {
                html += `<tr><td>${i+1}</td><td>${d.name}</td><td>${d.confidence}</td><td>${d.bbox}</td></tr>`;
            });
            html += '</table>';
            resultTable.innerHTML = html;
            // B·∫£ng nh√£n th·∫≠t
            if(result.ground_truth && result.ground_truth.length > 0) {
                let gthtml = '<div class="section-title">ƒê·ªëi chi·∫øu v·ªõi nh√£n th·∫≠t (ground truth)</div>';
                gthtml += '<table class="table table-result table-bordered"><tr><th>STT</th><th>T√™n lo√†i</th><th>Bounding Box</th></tr>';
                result.ground_truth.forEach((g, i) => {
                    gthtml += `<tr><td>${i+1}</td><td>${g.name}</td><td>${g.bbox}</td></tr>`;
                });
                gthtml += '</table>';
                gtTable.innerHTML = gthtml;
            } else {
                gtTable.innerHTML = '<div class="status-box status-err">Kh√¥ng t√¨m th·∫•y nh√£n th·∫≠t cho ·∫£nh n√†y.</div>';
            }
            document.getElementById('cameraStatus').textContent = 'ƒê√£ x·ª≠ l√Ω xong';
            document.getElementById('cameraStatus').className = 'status-box status-ok';
        } catch (error) {
            document.getElementById('cameraStatus').textContent = 'L·ªói k·∫øt n·ªëi';
            document.getElementById('cameraStatus').className = 'status-box status-err';
        } finally {
            setTimeout(() => {
                liveView.src = `http://${esp32_ip}/stream`;
                liveView.style.display = '';
            }, 500);
        }
    }
</script>
</body>
</html> 